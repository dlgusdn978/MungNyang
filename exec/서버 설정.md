# Openvidu 백엔드 및 프론트엔드 배포, SSL 인증서 적용

## 1. 개발 환경

### Front-end

- React.js v18.2.0
- Redux v8.1.1
- Styled-Component v6.0.5
- WebRTC - OpenVidu v2.28.0
- node v16.20.1
- Kakao Message API

### Back-end

- openjdk:11
  - 11.0.20+8 Azul Zulu: 11.66.15
- Spring Boot v2.7.14
- MariaDB v10.5.21
- Spring Data JPA
- Querydsl

### INFRA

- AWS EC2
- Docker v24.0.5
- Nginx

### IDE

- IntelliJ v2023.1.3
- VSCode
- HeidiSQL

---

## EC2 환경설정

### 1. Docker 설치

```bash
sudo apt-get update
sudo apt-get install ca-certificates curl gnupg

sudo install -m 0755 -d /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
sudo chmod a+r /etc/apt/keyrings/docker.gpg

echo \
  "deb [arch="$(dpkg --print-architecture)" signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
  "$(. /etc/os-release && echo "$VERSION_CODENAME")" stable" | \
  sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

sudo apt-get update
```

### 2. Docker Engine 설치

https://docs.docker.com/engine/install/ubuntu/

```bash
sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

sudo docker run hello-world
```

### 3. MariaDB 설치

```bash
sudo apt-get update
sudo apt install mariadb-server
sudo apt-get install mariadb-client
```

- User & Host 권한 변경

```bash

# 유저 생성
create user 'munguser'@'%' identified by 'mung209';

create database mung_game;
# 유저 권한 변경
mysql> grant all privileges on mung_game.* to 'munguser'@'%';

flush privileges;
```

## Openvidu 배포

- 오픈비두를 배포하기 root 권한을 얻어야 함

```bash
sudo su
```

- 오픈비두를 설치하기 위해 권장되는 경로인 `/opt`로 이동

```bash
cd /opt
```

- 오픈비두 설치

```bash
curl https://s3-eu-west-1.amazonaws.com/aws.openvidu.io/install_openvidu_latest.sh | bash
```

- 설치 후 오픈비두가 설치된 경로로 이동

```bash
$ cd openvidu
```

- 도메인 또는 퍼블릭IP와 오픈비두와 통신을 위한 환경설정

```bash
$ nano .env

# OpenVidu configuration
# ----------------------
# 도메인 또는 퍼블릭IP 주소
DOMAIN_OR_PUBLIC_IP=i9c209.p.ssafy.io

# 오픈비두 서버와 통신을 위한 시크릿
OPENVIDU_SECRET=MUNG

# Certificate type
CERTIFICATE_TYPE=letsencrypt

# 인증서 타입이 letsencrypt일 경우 이메일 설정
LETSENCRYPT_EMAIL=user@abc.com

# 녹화 변경
OPENVIDU_RECORDING=true

# 녹화파일에 모든 사용자 접근 허용....
OPENVIDU_RECORDING_PUBLIC_ACCESS=true
```

- 설정 후 오픈비두 서버 실행(`ctrl + c`를 누르면 백그라운드로 실행됨)

```bash
$ ./openvidu start

Creating openvidu-docker-compose_coturn_1          ... done
Creating openvidu-docker-compose_app_1             ... done
Creating openvidu-docker-compose_kms_1             ... done
Creating openvidu-docker-compose_nginx_1           ... done
Creating openvidu-docker-compose_redis_1           ... done
Creating openvidu-docker-compose_openvidu-server_1 ... done

----------------------------------------------------

   OpenVidu Platform is ready!
   ---------------------------

   * OpenVidu Server: https://DOMAIN_OR_PUBLIC_IP/

   * OpenVidu Dashboard: https://DOMAIN_OR_PUBLIC_IP/dashboard/

----------------------------------------------------

```

- 포트 설정

```bash
sudo apt install ufw

# Openvidu 포트설정
ufw allow ssh
ufw allow 80/tcp
ufw allow 443/tcp
ufw allow 3478/tcp
ufw allow 3478/udp
ufw allow 40000:57000/tcp
ufw allow 40000:57000/udp
ufw allow 57001:65535/tcp
ufw allow 57001:65535/udp

# DB 포트
ufw allow 3306

ufw enable
```

## git clone 및 배포 과정

### 1. git clone

```bash
git clone https://lab.ssafy.com/s09-webmobile1-sub2/S09P12C209.git
```

### 3. 프론트엔드 빌드 및 배포

- front-end 경로에 다음과 같은 Dockerfile이 있습니다. 이를 이용하여 Docker Container를 이용하여 프론트엔드를 배포할 준비를 합니다.
- 로컬에서 image 화 된 컨테이너를 Docker hub 로 업로드.

```bash
# Dockerfile

# 이미지의 기반이 되는 Node.js 이미지 선택
FROM node:16.20.1-alpine

# 애플리케이션 코드를 담을 디렉토리 생성 및 작업 디렉토리 설정
WORKDIR /app

# 애플리케이션 종속성을 복사하고 설치
COPY package*.json ./

# Install project dependencies
RUN npm install

# Copy the rest of the application code to the container
COPY . .

# Start the application
CMD ["npm", "start"]
```

프로젝트 폴더 내에 있는 front-end 디렉토리의 루트 경로에서 다음의 명령어를 실행합니다.

이후에는 다음의 명령어를 차례로 입력하여 module 설치 및 빌드, docker 이미지를 만드는 과정을 거칩니다. 그 이후에 배포를 완료합니다.

```bash
# module 설치
npm install

# 도커 이미지 빌드
docker build -t {개인허브}/mung-fe:0.0.1 .
```

### 4. 백엔드 빌드 및 배포 과정

- back-end 경로에 다음과 같은 Dockerfile이 있습니다. 이를 이용하여 Docker Container를 이용하여 백엔드를 배포할 준비를 합니다.
  로컬에서 image 화 된 컨테이너를 Docker hub 로 업로드.

```bash
# Dockerfile
FROM openjdk:11
ARG JAR_FILE=build/libs/*.jar
COPY ${JAR_FILE} mung.jar
ENTRYPOINT ["java","-jar","/mung.jar"]
```

프로젝트 폴더 내에 있는 back-end 디렉토리의 루트 경로에서 다음의 명령어를 실행합니다.

이후에는 다음의 명령어를 차례로 입력하여 module 설치 및 빌드, docker 이미지를 만드는 과정을 거칩니다. 그 이후에 배포를 완료합니다.

```bash
# jar 파일 생성
gradlew build
# 도커 이미지 빌드
docker build -t {개인허브}/mung:0.0.1 .
```

### 5. Openvidu docker-compose.yml 변경

a. 백엔드 이미지 Docker에 upload 한 컨테이너로 교체

b. 프론트 이미지 설정 추가

```bash
react-app:
        image: {개인허브}/mung-fe:0.0.1
        restart: on-failure
        network_mode: host
        logging:
            options:
                max-size: "${DOCKER_LOGS_MAX_SIZE:-100M}"
```

### 6. Nginx 설정과 ssl 인증서 발급 및 적용

Openvidu 같은 경우, 카메라를 사용하기 위해서는 반드시 https로 이용해야 하기에 SSL 인증서를 발급받아야 합니다. 인증서 발급을 위해서는 도메인이 필요합니다.

먼저 nginx를 다운 받습니다.

```bash
# 설치
sudo apt-get install nginx

# 설치 확인 및 버전 확인
nginx -v
```

letsencrypt 설치를 위해 다음과 같은 순서로 명령어를 입력합니다.

```bash
sudo apt-get install letsencrypt

sudo systemctl stop nginx

sudo letsencrypt certonly --standalone -d www제외한 도메인 이름
```

이렇게 한 후, "Congratulations!"로 시작하는 문구가 보이면, 인증서 발급이 완료된 것입니다.

인증서 발급 후, /etc/nginx/sites-available로 이동한 후, 적절한 이름의 파일을 생성하여 다음과 같이 작성합니다.

```bash
server {

        location /{
                proxy_pass http://localhost:3000;
        }

        location /api {
                proxy_pass http://localhost:8080/api;
        }

    listen 443 ssl; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/i5a608.p.ssafy.io/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/i5a608.p.ssafy.io/privkey.pem; # managed by Certbot
    # include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    # ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
}

server {
    if ($host = www제외한 도메인 이름) {
        return 301 https://$host$request_uri;
    } # managed by Certbot

        listen 80;
        server_name i5a608.p.ssafy.io;
    return 404; # managed by Certbot
}
```

그 후에 차례로 명령을 실행한다.

```bash
sudo ln -s /etc/nginx/sites-available/[파일명] /etc/nginx/sites-enabled/[파일명]

# 다음 명령어에서 successful이 뜨면 nginx를 실행할 수 있다.
sudo nginx -t

sudo systemctl restart nginx
```

이렇게 실행하면, http로 80포트 접근시, 443 포트(https)로 리다이렉트 된다. 그리고 백엔드 url을 /api/\*\*로 분기처리할 수 있다. `https://도메인주소` 로 접근하면 배포한 웹 페이지에 접속할 수 있게된다. 이것으로 배포 과정을 마친다.
